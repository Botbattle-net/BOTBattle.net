<!doctype html>
<html lang="zh">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
            crossorigin="anonymous">
        <title>黄金点游戏</title>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col game-info">
                    <div class="alert alert-info" role="alert">

                        <h4 class="alert-heading">黄金点游戏</h4>
                        <p>N个玩家，每人写一个0~100之间的有理数 (不包括0或100)，提交给服务器，服务器在当前回合结束时算出所有数字的平均值，然后乘以0.618（所谓黄金分割常数），得到G值。提交的数字最靠近G（取绝对值）的玩家得到N分，离G最远的玩家得到－2分，其他玩家得0分。只有一个玩家参与时不得分。</p>
                        <hr>
                        <div id='login-panel'>
                            <input type='text' class='form-control' placeholder="用户名" name="username">
                            <!-- <input type='text' class='form-control' placeholder="密码" name="password"> -->
                            <button id='loginBtn' class="btn btn-primary btn-block">登录</button>
                        </div>
                        <div id='user-info' style="display: none">
                            <div class='row'>
                                <div class='col'>
                                    <p id='pUsername'></p>
                                </div>
                                <div class='col'>
                                    <button id='logoutBtn' class="btn btn-primary btn-block">注销</button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div id='setRoom-panel'>
                            <div class="row">
                                <div class="col">
                                    <input type='text' class='form-control' placeholder="房间号" name="roomid">
                                </div>
                                <div class="col">
                                    <button id='setRoomBtn' class="btn btn-primary btn-block">进入房间</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="player-panel">
                <div class="row">
                    <div class="col">
                        <div class="row" style="margin-left:2px">
                            <p>当前房间：</p>
                            <p id="pRoomid"></p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="row">
                            <p>距本回合结束还有：</p>
                            <p id="remainTime"></p>
                        </div>
                    </div>
                </div>
                <!-- 访问GET,"userAct/", 参数roomid=从cookie里读出来房间号 num1=数字1 num2=数字2 -->
                <input type="text" class="form-control" placeholder="你的数字1" name="num1">
                <input type="text" class="form-control" placeholder="你的数字2" name="num2">
                <button id="submitNumBtn" type="button" class="btn btn-success btn-block">提交</button>
            </div>
            <hr>
            <div class="row last-result">
                <div class="col">
                    <h5>回合数</h5>
                </div>
                <div class="col">
                    <div class="row">
                        <p>黄金点：</p>
                        <p>TODO</p>
                    </div>
                </div>
            </div>
            <hr>
            <div class="history">
                <h5>对局历史</h5>
                <p>TODO</p>
            </div>
        </div>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
        <script type='text/javascript'>
            function setCookie(key, value, iDay) {
                    var oDate = new Date();
                    oDate.setDate(oDate.getDate() + iDay);
                    document.cookie = key + '=' + value + ';expires=' + oDate;

                }
            function removeCookie(key) {
                setCookie(key, '', -1)
            }
            function getCookie(key) {
                var cookieArr = document.cookie.split('; ');
                for (var i = 0; i < cookieArr.length; i++) {
                    var arr = cookieArr[i].split('=');
                    if (arr[0] === key) {
                        return arr[1];
                    }
                }
                return false;
            }
            function Timer(time) {
                var timer = null;
                var t = time;
                var m = 0;
                var s = 0;
                m = Math.floor(t / 60 % 60);
                m < 10 && (m = '0' + m);
                s = Math.floor(t % 60);
                function countDown() {
                    s--;
                    s < 10 && (s = '0' + s);
                    if (s.length >= 3) {
                        s = 59;
                        m = "0" + (Number(m) - 1);
                    }
                    if (m.length >= 3) {
                        m = '00';
                        s = '00';
                        clearInterval(timer);
                    }
                    $('#remainTime').html(m+":"+s)
                }
                timer = setInterval(countDown, 1000);
            }
            $(document).ready(function() {
                $.get('userStatus/', function(data, status){
                    if (data != "No User Log In"){
                        $('#pUsername').html("当前登陆：" + data)
                        $('#login-panel').css("display", "none")
                        $('#user-info').css("display", "block")
                        setCookie("username", data, 1);
                    }
                })
                $('#pRoomid').html(getCookie('roomid'))
                //$.get("/",function(data,status){
                    //Timer(60)
                //})
                Timer(100);
            })
            $('#setRoomBtn').click(
                function trySetRoom() {
                    var roomid = $('input[name="roomid"]').val();
                    var json = {"roomid":roomid}
                    console.log(roomid);
                    $.get('roomStatus/', json, function(data, status){
                        if (data == "on"){
                            setCookie('roomid', roomid, 1);
                            $('#pRoomid').html(roomid)
                        }else{
                            alert("The room is off");
                        }
                    })
                }
            )
            $('#loginBtn').click(
                function tryLogin() {
                    var uname = $('input[name="username"]').val();
                    // var pw = $('input[name="password"]').val();
                    console.log(uname);
                    // console.log(pw);
                    var json = {"name":uname}
                    console.log(json);
                    $.get('userReg/',json,function(data,status){
                        // check the logged in status
                        console.log(data);
                        console.log(status);
                        if (data == "User register success" || data == "User login success"){
                            setCookie("username", data, 1);
                            $('#pUsername').html("当前登陆：" + uname)
                            $('#login-panel').css("display", "none")
                            $('#user-info').css("display", "block")
                        }
                        alert(data);
                    })
                }
            )
            $('#logoutBtn').click(
                function tryLogout() {
                    $.get('userOut/', function(data, status){
                        removeCookie("username");
                        alert(data);
                    })
                    $('#pUsername').html("")
                    $('#login-panel').css("display", "block")
                    $('#user-info').css("display", "none")
                }
            )
            $('#submitNumBtn').click(
                function sumbitNum(){
                    var num1 = $('input[name="num1"]').val();
                    var num2 = $('input[name="num2"]').val();
                    var roomid = getCookie("roomid");
                    var json = {"roomid":roomid,"num1":num1,"num2":num2}
                    console.log(json);
                    $.get('userAct/',json,function(data,status){
                        alert(data);
                    })
                }
            )
        </script>
    </body>
</html>